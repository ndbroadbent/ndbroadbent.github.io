<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="author" content="map[]" />
    <meta name="description" content="Web, mobile, electronics, music">
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">
    <title>How Docker Saved My Blog</title>
    <meta name="generator" content="Hugo 0.21" />

    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="/css/main.css" />
    <link rel="stylesheet" type="text/css" href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" />
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Lato:400,700|Merriweather|Roboto+Mono">
    

    <!--[if lt IE 9]>
			<script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
			<script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
		<![endif]-->

    
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-19054098-3', 'auto');
ga('send', 'pageview');
</script>

  </head>

  <body>
    <div id="wrap">

      
      
<nav class="navbar navbar-default">
  <div class="container">
    <div class="navbar-header">
      <a class="navbar-brand" href="https://madebynathan.com/">
        Made by Nathan
      </a>
    </div>
    <div id="navbar">
      <ul class="nav navbar-nav navbar-right">
      
        
        <li><a href="/posts/">
          Posts</a>
        </li>
        
        <li><a href="https://ndbroadbent.com">
          Consulting</a>
        </li>
        
      
      </ul>
    </div>
  </div>
</nav>

      
      <div class="container">
        <div class="blog-post">
          <h3>
            <strong><a href="https://madebynathan.com/posts/2021-12-05-how-docker-saved-my-blog/">How Docker Saved My Blog</a></strong>
          </h3>
        </div>
        <div class="blog-title">
          <h4>
          December 5, 2021
          </h4>

        </div>
        <div class="panel panel-default">
          <div class="panel-body">
            <div class="blogpost">
              

<p>I haven&rsquo;t written any blog posts for a while. One reason is that I&rsquo;ve been hard at work on <a href="https://docspring.com">DocSpring</a> for the last few years, and I haven&rsquo;t had a lot of time to work on personal projects. But the main reason is that my blog uses an older version of <a href="https://gohugo.io/">Hugo</a>, which is a &ldquo;static site generator&rdquo; <sup class="footnote-ref" id="fnref:1"><a rel="footnote" href="#fn:1">1</a></sup>.</p>

<p>I switched from Jekyll to Hugo in 2017, and the current version of Hugo at the time was <a href="https://gohugo.io/news/0.21-relnotes/"><code>0.21</code></a>. I found a cool theme called <a href="https://github.com/suyundukov/hugo-sustain">hugo-sustain</a>. Everything was great for a few years.</p>

<p>Time passed. One day, I tried to update a post or write a new post (I can&rsquo;t remember which), and I realized that my <code>build</code> and <code>develop</code> scripts were broken. I was a new computer at that point, and I had updated my macOS version. I installed the latest version of <code>hugo</code> and saw a bunch of interesting and confusing error messages when it tried to compile my old themes and layouts. I tried to downgrade <code>hugo</code> to version <code>0.21</code>, and it crashed with a segfault (it was built for an older version of macOS.) I cloned the <code>hugo</code> repository and tried to compile it from source, but my Go version was too new, so it failed to compile. Finally, I downgraded my Go version to an older version that was released around the same time in 2017. I held my breath as I tried to compile <code>hugo</code> one last time. Go tried to fetch all of the required dependencies, and crashed with a bunch of 404 errors. Apparently some of the packages had been renamed and moved around, and the older versions had been removed from the Go package index.</p>

<p>So I gave up for a while. Instead of generating my blog from the source, I switched to editing the static files directly. Sometimes I would need to correct a typo or adjust some styles, so I&rsquo;d go into the generated <code>./public</code> directory and manually modify the raw HTML and CSS.</p>

<p>Time passed. One day, I started to notice some activity on <a href="/2010/05/13/scanning-lots-of-photos-at-once/">a blog post that I had written 11 years ago</a>. This post is about a GIMP plugin called <code>deskew</code> that makes it easy to scan old photos in batches on a scanner and automatically rotate them. I had dropped this plugin file in my Google Drive and had pasted a link to the file. The link worked great for 10 years, and people were able to download the file without any issues. But eventually Google changed something and the link was no longer working. I started to receive emails from people who were requesting access to this file.</p>

<p><img class="lightbox thumb" src="/images/posts/2021/12/request-to-access-deskew.jpeg" alt="Request to access the deskew file" /></p>

<p>I manually shared the file a few times. Then I decided to download the file and check it in to the blog repo. I started going into the <code>./public</code> directly to update the HTML, but I decided it was time to have another crack at this Hugo problem and fix my blog.</p>

<p>Should I switch to Ghost? I&rsquo;ve loved using Ghost for the <a href="https://docspring.com/blog">DocSpring blog</a>. It&rsquo;s a really nice blogging platform that I self-host on <a href="https://www.digitalocean.com/">Digital Ocean for $5/mo</a>, and I enjoy the WYSIWYG writing experience a little more than editing plain Markdown files. (Images are a bit annoying.) But I didn&rsquo;t want to migrate all my posts over to <a href="https://ghost.org/">ghost.org</a> and get locked in, or spend $5/mo for the rest of my life. I just want some static HTML/CSS that I can put on GitHub Pages forever.</p>

<p>Should I upgrade to the latest version of Hugo and spend hours fixing up the themes and tweaking all my posts until everything is working again? No thanks. Hugo runs on my local machine and produces static HTML and CSS content. It&rsquo;s a <a href="https://www.wikiwand.com/en/Pure_function">pure function</a>. There are no security vulnerabilities to watch out for. As far as I&rsquo;m concerned, Hugo version <code>0.21</code> is &ldquo;finished software.&rdquo; It generates my blog, and I&rsquo;m happy with my blog. I will continue to be happy with my blog for many years to come. I don&rsquo;t need the latest and greatest features. I just want something stable that I can use over the next few decades without the constant grind of updating packages, breaking things, and debugging random issues. Give me Hugo <code>0.21</code> from May 2017!</p>

<p>I had a sudden burst of inspiration:</p>

<h1 id="docker">Docker!</h1>

<p>I could run Hugo in a Docker image! If I can get Hugo <code>0.21</code> running in a Docker image, then I can save that Docker image into a <code>*.tar.gz</code> file and store it right in my git repo. Then I have a static <code>hugo</code> binary that comes packaged with everything it needs to run in a consistent environment, and I can run it anywhere (Linux, Mac OS, Windows.)</p>

<p>I found a <a href="https://github.com/jonathanbp/docker-alpine-hugo/blob/master/Dockerfile">Dockerfile in this docker-alpine-hugo repo</a>, and I just needed to change <code>0.55.3</code> to <code>0.21</code>. Everything worked on the first try! <sup class="footnote-ref" id="fnref:2"><a rel="footnote" href="#fn:2">2</a></sup></p>

<h3 id="how-i-use-docker">How I use Docker</h3>

<p>Instead of running <code>hugo</code>, I run a <code>./hugo</code> wrapper script that runs <code>hugo</code> inside a Docker container:</p>

<pre><code class="language-bash">#!/bin/bash
docker run --rm -v &quot;${PWD}:/src&quot; hugo-alpine hugo &quot;$@&quot;
</code></pre>

<p>I have a <code>build_docker</code> script <sup class="footnote-ref" id="fnref:3"><a rel="footnote" href="#fn:3">3</a></sup> that builds the Docker image and saves it to <code>hugo-alpine.tar.gz</code>:</p>

<pre><code class="language-bash">#!/bin/bash
set -euo pipefail

echo &quot;Building Dockerfile...&quot;
docker build . -t hugo-alpine
echo &quot;Saving image to hugo-alpine.tar.gz&quot;
docker save hugo-alpine &gt; hugo-alpine.tar.gz
</code></pre>

<p>If I&rsquo;m on a new computer, I can just run <code>docker load -i hugo-alpine.tar.gz</code> to load the <code>hugo-alpine</code> image into Docker. The nice thing is that this image is completely portable, and I can run it on Mac, Windows, or Linux. I just need to trust that Docker will continue to exist in the future, and that I&rsquo;ll always be able to run this kind of Docker image. I&rsquo;m pretty sure that Docker is going to be around for a long time.</p>

<p>I have a <code>dev</code> script that starts the <code>hugo</code> server and makes it available on port <code>1313</code>:</p>

<pre><code class="language-bash">#!/bin/bash
docker run --rm -v &quot;${PWD}:/src&quot; -p 1313:1313 hugo-alpine hugo --watch serve --bind 0.0.0.0
</code></pre>

<p>Finally, I have a <code>deploy</code> script that generates the static site into <code>./public</code>, then pushes the result to a <code>gh-pages</code> branch:</p>

<pre><code class="language-bash">#!/bin/bash
set -euo pipefail

if [ ! -d public/.git ]; then
  rm -rf public
  REMOTE=&quot;$(git remote get-url origin)&quot;
  git clone &quot;${REMOTE}&quot; public
  (cd public &amp;&amp; git checkout gh-pages)
fi

docker run --rm -v &quot;${PWD}:/src&quot; hugo-alpine hugo

cd public
git add -A
git commit -m &quot;$(date)&quot;
echo &quot;Pushing build...&quot;
git push

cd ..
echo &quot;Pushing source...&quot;
git push
</code></pre>

<h3 id="you-can-view-the-source-code-for-my-blog-here-https-github-com-ndbroadbent-ndbroadbent-github-io">You can view the source code for my blog here: <a href="https://github.com/ndbroadbent/ndbroadbent.github.io">https://github.com/ndbroadbent/ndbroadbent.github.io</a></h3>

<hr />

<p>I&rsquo;m very happy with this workaround. Before I realized that I could fix this with Docker, I was even tempted to switch to something written in Bash, C, or Perl. Go and Rust are cool new languages, but they continue to &ldquo;move fast and break things.&rdquo; The POSIX standard was created 33 years ago in 1988, so I could still run some shell scripts that are over 30 years old. (I asked Hacker News for some examples: <a href="https://news.ycombinator.com/item?id=29446380">Ask HN: What is the oldest Posix script that I can still run in a modern shell?</a>.)</p>

<p>Now I&rsquo;m back in business, and I can update or write new blog posts to my heart&rsquo;s content. This new Docker-based setup should last me for the next few decades at least. I&rsquo;m in no hurry to switch to anything else.</p>
<div class="footnotes">

<hr />

<ol>
<li id="fn:1">A <a href="https://www.cloudflare.com/learning/performance/static-site-generator/">static site generator</a> converts a folder full of Markdown files into a plain HTML/CSS website that you can host for free on <a href="https://pages.github.com/">GitHub Pages</a> or <a href="https://www.netlify.com/">Netlify</a>.
 <a class="footnote-return" href="#fnref:1"><sup>[return]</sup></a></li>
<li id="fn:2">I think it&rsquo;s generally much easier to get older Linux packages running, especially when it&rsquo;s a single Go binary with no dependencies. I wish it was this easy on Mac!
 <a class="footnote-return" href="#fnref:2"><sup>[return]</sup></a></li>
<li id="fn:3">Hopefully I never have to run this again!
 <a class="footnote-return" href="#fnref:3"><sup>[return]</sup></a></li>
</ol>
</div>


              <div class="related-posts">
                <h5>Related Posts</h5>
                
              </div>
            </div>
          </div>

        <div class="disqus">
  <div id="disqus_thread"></div>
  <script type="text/javascript">

    (function() {
      
      
      if (window.location.hostname == "localhost")
        return;

      var disqus_shortname = 'madebynathan';
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  <a href="http://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>

        </div>
      </div>
      
    </div>

    
    <footer>
  <div id="footer">
    <div class="container">
      <p class="text-muted">&copy; All rights reserved. Powered by <a href="https://gohugo.io/">Hugo</a> and
      <a href="http://www.github.com/nurlansu/hugo-sustain/">sustain</a> with ♥</p>
    </div>
  </div>
</footer>
<div class="footer"></div>


<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>

<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<script src="https://madebynathan.com/js/docs.min.js"></script>
<script src="https://madebynathan.com/js/main.js"></script>

<script src="https://madebynathan.com/js/ie10-viewport-bug-workaround.js"></script>



  </body>
</html>
